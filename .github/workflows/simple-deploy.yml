name: ğŸš€ CD - Deploy to GCP

on:
  push:
    branches: [ main, deploy-production ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  PROJECT_ID: facturasbst
  REGION: us-central1
  REPOSITORY: facturas-repo
  BUCKET_NAME: facturas-frontend-facturasbst-1759186561

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    name: ğŸ Deploy Backend to Cloud Run
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: â˜ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: ğŸ—ï¸ Build and push Docker image
      run: |
        gcloud builds submit --tag $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/backend:latest ./backend
        
    - name: ğŸš€ Deploy to Cloud Run
      run: |
        gcloud run deploy backend \
          --image $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/backend:latest \
          --platform managed \
          --region $REGION \
          --allow-unauthenticated \
          --port 8000 \
          --memory 2Gi \
          --cpu 2 \
          --max-instances 10 \
          --min-instances 0 \
          --timeout 300 \
          --set-env-vars="DATABASE_URL=${{ secrets.DATABASE_URL }},SECRET_KEY=${{ secrets.SECRET_KEY }},GMAIL_CLIENT_ID=${{ secrets.GMAIL_CLIENT_ID }},GMAIL_CLIENT_SECRET=${{ secrets.GMAIL_CLIENT_SECRET }}"

  deploy-frontend:
    runs-on: ubuntu-latest
    name: âš›ï¸ Deploy Frontend to Cloud Storage
    needs: deploy-backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ—ï¸ Build project
      run: |
        cd frontend
        npm run build
        
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: â˜ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: ğŸ—‚ï¸ Upload to Cloud Storage
      run: |
        gsutil -m cp -r frontend/dist/* gs://$BUCKET_NAME/
        gsutil -m cp frontend/dist/index.html gs://$BUCKET_NAME/index.html
        gsutil -m setmeta -h "Cache-Control:no-cache" gs://$BUCKET_NAME/index.html

  notify:
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify Deployment
    needs: [deploy-backend, deploy-frontend]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify Success
      if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
      run: |
        echo "âœ… Deployment successful!"
        echo "Backend: https://backend-$REGION-$PROJECT_ID.a.run.app"
        echo "Frontend: https://storage.googleapis.com/$BUCKET_NAME/index.html"
        echo "API Health: https://backend-$REGION-$PROJECT_ID.a.run.app/health"
        
    - name: ğŸ“¢ Notify Failure
      if: needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        echo "Backend status: ${{ needs.deploy-backend.result }}"
        echo "Frontend status: ${{ needs.deploy-frontend.result }}"